#!/usr/bin/env bash

mkpdir() {
    mkdir "$1"/"$2"
}

createdKittySession() {
    local parentdir="$1"
    local projectname="$2"
    printf "layout tall\nnew_tab terminal\ncd %s/%s\nlaunch bash\nnew_tab yazi\ncd %s/%s\nlaunch yazi\n" \
        "$parentdir" "$projectname" \
        "$parentdir" "$projectname" \
        >"$parentdir"/"$projectname"/launch.kitty-session
    sync
}

launchProject() {
    local parentdir="$1"
    local projectname="$2"
    setsid kitty --instance-group "$projectname" --session "$parentdir"/"$projectname"/launch.kitty-session &
    emacsclient -n -a "" "$parentdir"/"$projectname" &
}

createProject() {
    local languagechoice="$1"
    local parentdir="$2"
    local projectname="$3"

    case $languagechoice in
    rust)
        echo '{{ Color "99" " Creating a rust project "}}' | gum format -t template
        echo
        printf '{{ Color "99" " Creating project @ %s/%s "}}' "$parentdir" "$projectname" | gum format -t template
        echo
        cd "$parentdir" || exit
        cargo new "$projectname"
        createdKittySession "$parentdir" "$projectname"
        ;;
    go)
        echo '{{ Color "99" " Creating a go project "}}' | gum format -t template
        echo
        printf '{{ Color "99" " Creating project @ %s/%s "}}' "$parentdir" "$projectname" | gum format -t template
        echo
        mkpdir "$parentdir" "$projectname"
        cd "$parentdir"/"$projectname" || exit
        go mod init "$projectname"
        git init
        cat ~/nix-config/dotfiles/git/Go.gitignore >"$parentdir"/"$projectname"/.gitignore
        createdKittySession "$parentdir" "$projectname"
        ;;
    zig)
        echo '{{ Color "99" " Creating a zig project "}}' | gum format -t template
        echo
        printf '{{ Color "99" " Creating project @ %s/%s "}}' "$parentdir" "$projectname" | gum format -t template
        echo
        mkpdir "$parentdir" "$projectname"
        cd "$parentdir"/"$projectname" || exit
        zig init
        git init
        cat ~/nix-config/dotfiles/git/Zig.gitignore >"$parentdir"/"$projectname"/.gitignore
        createdKittySession "$parentdir" "$projectname"
        ;;
    python)
        echo '{{ Color "99" " Creating a python project "}}' | gum format -t template
        echo
        printf '{{ Color "99" " Creating project @ %s/%s "}}' "$parentdir" "$projectname" | gum format -t template
        echo
        cd "$parentdir" || exit
        uv init "$projectname"
        createdKittySession "$parentdir" "$projectname"
        ;;
    bash)
        echo '{{ Color "99" " Creating a bash project "}}' | gum format -t template
        echo
        printf '{{ Color "99" " Creating project @ %s/%s "}}' "$parentdir" "$projectname" | gum format -t template
        echo
        mkpdir "$parentdir" "$projectname"
        cd "$parentdir"/"$projectname" || exit
        git init
        cat ~/nix-config/dotfiles/git/Shell.gitignore >"$parentdir"/"$projectname"/.gitignore
        printf "#!/usr/bin/env bash\n\n" >"$projectname"
        chmod +x "$projectname"
        createdKittySession "$parentdir" "$projectname"
        ;;
    *)
        echo '{{ Color "99" " Creating a project "}}' | gum format -t template
        echo
        printf '{{ Color "99" " Creating project @ %s/%s "}}' "$parentdir" "$projectname" | gum format -t template
        echo
        mkpdir "$parentdir" "$projectname"
        cd "$parentdir"/"$projectname" || exit
        git init
        cat ~/nix-config/dotfiles/git/C.gitignore >"$parentdir"/"$projectname"/.gitignore
        createdKittySession "$parentdir" "$projectname"
        ;;
    esac
}

main() {
    gum style \
        --foreground 212 --border-foreground 212 --border double \
        --align center --width 50 --margin "1 2" --padding "2 4" \
        'Create a new project'

    local projectname
    projectname=$(gum input --placeholder "Project Name")
    [[ -z "$projectname" ]] && exit 1

    local parentdirchoice
    parentdirchoice=$(gum choose github projects)

    local parentdir
    case $parentdirchoice in
    github)
        parentdir=$HOME/workspaces/github/CodyBense
        ;;
    *)
        parentdir=$HOME/workspaces/projects
        ;;
    esac

    local languagechoice
    languagechoice=$(gum choose go rust zig c python bash)

    createProject "$languagechoice" "$parentdir" "$projectname"

    echo '{{ Color "99" " Do you want to launch the project "}}' | gum format -t template
    sleep 1
    # gum confirm && launchProject "$parentdir" "$projectname" || exit
    if gum confirm; then
        launchProject "$parentdir" "$projectname"
    fi
}

main
